<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Package Manager Tools</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f2f5;
        }

        .container {
            width: 70%;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Tab Styles */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e1e4e8;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #586069;
            position: relative;
        }

        .tab.active {
            color: #2196F3;
            font-weight: bold;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #2196F3;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e1e4e8;
            flex: 1;
        }

        button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
        }

        .toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-left: 10px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background: white;
        }

        .error { color: red; }
        .success { color: green; }

        /* Log Section Styles */
        .log-container {
            height: 300px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #fff;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            margin-bottom: 10px;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
        }

        .log-entry.success { color: #28a745; }
        .log-entry.error { color: #dc3545; }
        .log-entry.warning { color: #ffc107; }
        .log-entry.info { color: #17a2b8; }
        .log-entry.debug { color: #6c757d; }
        .log-entry.request { color: #9c27b0; }
        .log-entry.response { color: #4caf50; }

        .log-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .log-btn {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .log-btn:hover {
            background: #5a6268;
        }

        .log-btn i {
            font-size: 16px;
        }

        /* Add this to your existing styles */
        .manager-container {
            display: flex;
            gap: 20px;
            justify-content: space-between;
        }

        .package-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 10px;
        }

        .package-card {
            background: white;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 15px;
            position: relative;
        }

        .package-card h4 {
            margin: 0 0 10px 0;
            color: #24292e;
        }

        .package-desc {
            color: #586069;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .package-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid #e1e4e8;
        }

        .package-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .refresh-btn {
            padding: 4px 8px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .refresh-btn:hover {
            background: #5a6268;
        }

        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .refresh-icon {
            display: inline-block;
            transition: transform 0.3s ease;
        }

        .refresh-btn:active .refresh-icon {
            transform: rotate(180deg);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .installed {
            background-color: #28a745;
            color: white;
        }

        .not-installed {
            background-color: #dc3545;
            color: white;
        }

        .version {
            color: #586069;
            font-size: 12px;
        }

        .package-toggle {
            width: 50px;
            height: 26px;
            margin: 0;
        }

        .package-toggle .slider {
            height: 26px;
        }

        .package-toggle .slider:before {
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
        }

        .package-toggle input:checked + .slider:before {
            transform: translateX(24px);
        }

        .status-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-controls {
            margin-bottom: 20px;
            display: flex;
            justify-content: flex-end;
        }

        .bulk-check-btn {
            padding: 8px 16px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .bulk-check-btn:hover {
            background: #1976D2;
        }

        .bulk-check-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .bulk-check-btn .refresh-icon {
            display: inline-block;
            transition: transform 0.3s ease;
        }

        .bulk-check-btn:disabled .refresh-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .bulk-refresh-btn {
            padding: 8px 16px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .bulk-refresh-btn:hover {
            background: #1976D2;
        }

        .bulk-refresh-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .bulk-refresh-btn .refresh-icon {
            display: inline-block;
            transition: transform 0.3s ease;
        }

        .bulk-refresh-btn:disabled .refresh-icon {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="openTab('managers')">Package Managers</button>
            <button class="tab" onclick="openTab('status')">Winget Package Status</button>
            <button class="tab" onclick="openTab('logs')">Logs</button>
        </div>

        <div id="managers" class="tab-content active">
            <div class="manager-container">
                <div class="section">
                    <h3>Winget</h3>
                    <button id="checkWinget">Check Version</button>
                    <div id="wingetResult" class="result"></div>
                </div>

                <div class="section" id="chocoSection">
                    <h3>Chocolatey</h3>
                    <button id="checkChoco">Check Version</button>
                    <label class="toggle">
                        <input type="checkbox" id="chocoToggle">
                        <span class="slider"></span>
                    </label>
                    <div id="chocoResult" class="result"></div>
                </div>
            </div>
        </div>

        <div id="status" class="tab-content">
            <div class="section">
                <div class="status-controls">
                    <button class="bulk-refresh-btn" onclick="forceBulkStatusCheck()">
                        <span class="refresh-icon">‚Üª</span> Refresh All
                    </button>
                </div>
                <div class="package-grid">
                    <!-- Packages will be loaded here -->
                </div>
            </div>
        </div>

        <div id="logs" class="tab-content">
            <div class="log-controls">
                <button class="log-btn" onclick="copyLogs()">
                    <i>üìã</i> Copy Logs
                </button>
                <button class="log-btn" onclick="downloadLogs()">
                    <i>‚¨áÔ∏è</i> Download Logs
                </button>
                <button class="log-btn" onclick="clearLogs()">
                    <i>üóëÔ∏è</i> Clear Logs
                </button>
            </div>
            <div class="log-container" id="logContainer">
                <!-- Logs will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Global state to track package initialization
        let hasInitializedPackages = false;

        /**
         * Tab Management
         * Handles switching between different tabs (Package Managers, Package Status, Logs)
         * Also triggers initial package loading when status tab is first opened
         * @param {string} tabName - Name of the tab to open
         */
        function openTab(tabName) {
            // Log tab switch
            addLogEntry(`Switching to ${tabName} tab`, 'INFO');

            // Hide all tab contents
            const tabContents = document.getElementsByClassName('tab-content');
            for (let content of tabContents) {
                content.classList.remove('active');
            }

            // Remove active class from all tabs
            const tabs = document.getElementsByClassName('tab');
            for (let tab of tabs) {
                tab.classList.remove('active');
            }

            // Show the selected tab content
            document.getElementById(tabName).classList.add('active');
            // Add active class to the clicked tab
            event.currentTarget.classList.add('active');

            // Load packages only if it's the status tab and hasn't been initialized
            if (tabName === 'status' && !hasInitializedPackages) {
                addLogEntry('First time opening Status tab - initializing package list', 'INFO');
                loadPackages();
                hasInitializedPackages = true;
            }
        }

        /**
         * Log Entry Management
         * Adds a new log entry to the log container with timestamp and styling
         * @param {string} message - The log message to display
         * @param {string} type - The type of log (INFO, DEBUG, SUCCESS, WARNING, ERROR, REQUEST, RESPONSE)
         */
        function addLogEntry(message, type) {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type.toLowerCase()}`;
            
            // Add timestamp
            const timestamp = new Date().toLocaleTimeString();
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // Send log to server for persistence
            fetch('http://localhost:9000/api/log', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    type: type,
                    source: 'GUI'
                })
            }).catch(err => console.error('Failed to send log to server:', err));
        }

        /**
         * Log Management Functions
         * Handle copying, downloading, and clearing of logs
         */
        function copyLogs() {
            addLogEntry('Copying logs to clipboard', 'INFO');
            const logContainer = document.getElementById('logContainer');
            const logText = Array.from(logContainer.children)
                .map(entry => entry.textContent)
                .join('\n');
            
            navigator.clipboard.writeText(logText).then(() => {
                addLogEntry('Logs copied successfully', 'SUCCESS');
            }).catch(err => {
                addLogEntry(`Failed to copy logs: ${err.message}`, 'ERROR');
            });
        }

        function downloadLogs() {
            addLogEntry('Preparing logs for download', 'INFO');
            const logContainer = document.getElementById('logContainer');
            const logText = Array.from(logContainer.children)
                .map(entry => entry.textContent)
                .join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const timestamp = new Date().toISOString().slice(0,19).replace(/[:]/g, '-');
            a.href = url;
            a.download = `logs_${timestamp}.txt`;
            document.body.appendChild(a);
            a.click();
            
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            addLogEntry('Logs downloaded successfully', 'SUCCESS');
        }

        function clearLogs() {
            if (confirm('Are you sure you want to clear all logs?')) {
                const logContainer = document.getElementById('logContainer');
                logContainer.innerHTML = '';
                addLogEntry('Log history cleared', 'INFO');
            }
        }

        // Initialize UI elements
        const wingetBtn = document.getElementById('checkWinget');
        const chocoBtn = document.getElementById('checkChoco');
        const chocoToggle = document.getElementById('chocoToggle');

        /**
         * Winget Version Check
         * Queries the server for Winget version and updates UI accordingly
         */
        async function checkWinget() {
            const result = document.getElementById('wingetResult');
            wingetBtn.disabled = true;
            addLogEntry('Checking Winget version...', 'INFO');
            
            try {
                const response = await fetch('http://localhost:9000/api/winget-version');
                const data = await response.json();
                
                if (data.version && !data.version.includes('Error')) {
                    result.textContent = `Version: ${data.version}`;
                    result.className = 'result success';
                    addLogEntry(`Winget version check successful: ${data.version}`, 'SUCCESS');
                } else {
                    result.textContent = 'Winget not installed';
                    result.className = 'result error';
                    addLogEntry('Winget not installed', 'ERROR');
                }
            } catch (error) {
                result.textContent = 'Error checking version';
                result.className = 'result error';
                addLogEntry(`Error checking Winget version: ${error.message}`, 'ERROR');
            }
            wingetBtn.disabled = false;
        }

        /**
         * Chocolatey Version Check
         * Queries the server for Chocolatey version and updates UI accordingly
         */
        async function checkChoco() {
            const result = document.getElementById('chocoResult');
            chocoBtn.disabled = true;
            addLogEntry('Checking Chocolatey version...', 'INFO');
            
            try {
                const response = await fetch('http://localhost:9000/api/choco-version');
                const data = await response.json();
                
                if (data.version.installed) {
                    result.textContent = `Version: ${data.version.version}`;
                    result.className = 'result success';
                    chocoToggle.checked = true;
                    addLogEntry(`Chocolatey version check successful: ${data.version.version}`, 'SUCCESS');
                } else {
                    result.textContent = 'Chocolatey is not installed';
                    result.className = 'result error';
                    chocoToggle.checked = false;
                    addLogEntry('Chocolatey is not installed', 'WARNING');
                }
            } catch (error) {
                result.textContent = 'Error checking version';
                result.className = 'result error';
                addLogEntry(`Error checking Chocolatey version: ${error.message}`, 'ERROR');
            }
            chocoBtn.disabled = false;
        }

        /**
         * Chocolatey Installation Toggle Handler
         * Manages installation/uninstallation of Chocolatey based on toggle state
         */
        chocoToggle.addEventListener('change', async () => {
            const result = document.getElementById('chocoResult');
            const endpoint = chocoToggle.checked ? 'install' : 'uninstall';
            const action = chocoToggle.checked ? 'Installing' : 'Uninstalling';
            
            result.textContent = `${action}...`;
            result.className = 'result';
            addLogEntry(`${action} Chocolatey...`, 'INFO');
            
            try {
                // Perform installation/uninstallation
                const response = await fetch(`http://localhost:9000/api/choco-${endpoint}`);
                const data = await response.json();
                
                // Wait for operation to complete
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Verify installation status
                const verifyResponse = await fetch('http://localhost:9000/api/choco-version');
                const verifyData = await verifyResponse.json();
                
                const isInstalled = verifyData.version.installed;
                const shouldBeInstalled = endpoint === 'install';
                
                if (isInstalled === shouldBeInstalled) {
                    await checkChoco(); // Updates UI and logs success
                } else {
                    result.textContent = `${endpoint} failed`;
                    result.className = 'result error';
                    chocoToggle.checked = !chocoToggle.checked;
                    addLogEntry(`Chocolatey ${endpoint} failed - verification failed`, 'ERROR');
                }
            } catch (error) {
                result.textContent = `${endpoint} failed`;
                result.className = 'result error';
                chocoToggle.checked = !chocoToggle.checked;
                addLogEntry(`Error during Chocolatey ${endpoint}: ${error.message}`, 'ERROR');
            }
        });

        // Event Listeners for version check buttons
        wingetBtn.addEventListener('click', checkWinget);
        chocoBtn.addEventListener('click', checkChoco);

        /**
         * Package Management Functions
         * Handle loading, displaying, and managing package status
         */

        /**
         * Loads and displays all packages in the Winget Package Status tab
         * Creates cards for each package with status, version, and controls
         */
        async function loadPackages() {
            const packageGrid = document.querySelector('.package-grid');
            packageGrid.innerHTML = 'Loading packages...';
            addLogEntry('Loading package list...', 'INFO');

            try {
                // Check for cached package data
                const cachedData = sessionStorage.getItem('packageData');
                if (cachedData) {
                    addLogEntry('Using cached package data', 'INFO');
                    displayPackages(JSON.parse(cachedData));
                    return;
                }

                // Fetch package list from server
                const response = await fetch('http://localhost:9000/api/winget/packages-list');
                const data = await response.json();

                if (data.success) {
                    sessionStorage.setItem('packageData', JSON.stringify(data));
                    addLogEntry(`Successfully loaded ${data.packages.length} packages`, 'SUCCESS');
                    displayPackages(data);
                } else {
                    packageGrid.innerHTML = 'Error loading packages list';
                    addLogEntry('Failed to load packages list', 'ERROR');
                }
            } catch (error) {
                packageGrid.innerHTML = 'Error loading packages list';
                addLogEntry(`Error loading packages: ${error.message}`, 'ERROR');
            }
        }

        /**
         * Displays packages and their status from data
         * @param {Object} data - Package data to display
         */
        async function displayPackages(data) {
            const packageGrid = document.querySelector('.package-grid');
            packageGrid.innerHTML = '';
            addLogEntry('Rendering package cards...', 'DEBUG');
            
            // Create a card for each package
            for (const pkg of data.packages) {
                const card = document.createElement('div');
                card.className = 'package-card';
                
                // Set up card HTML with package info and controls
                card.innerHTML = `
                    <h4>${pkg.app_name}</h4>
                    <div class="package-desc">${pkg.app_desc}</div>
                    <div class="package-status">
                        <div class="status-info">
                            <span class="status-badge">Checking...</span>
                            <span class="version"></span>
                        </div>
                        <div class="package-controls">
                            <button class="refresh-btn" onclick="refreshPackage('${pkg.app_id}', this)">
                                <span class="refresh-icon">‚Üª</span>
                            </button>
                            <label class="toggle package-toggle">
                                <input type="checkbox" data-app-id="${pkg.app_id}">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                `;
                
                packageGrid.appendChild(card);
                
                // Set up toggle button event handler
                const toggle = card.querySelector('input[type="checkbox"]');
                toggle.addEventListener('change', () => handlePackageToggle(pkg.app_id, toggle));
            }

            // Check for cached status data
            const cachedStatus = sessionStorage.getItem('packageStatus');
            if (cachedStatus) {
                addLogEntry('Using cached package status data', 'INFO');
                updatePackageStatusFromCache(JSON.parse(cachedStatus));
            } else {
                addLogEntry('Performing initial bulk status check...', 'INFO');
                await performInitialBulkCheck();
            }
        }

        /**
         * Updates package status from cached data
         * @param {Object} statusData - Cached status data
         */
        function updatePackageStatusFromCache(statusData) {
            addLogEntry('Updating package status from cache...', 'DEBUG');
            const packageCards = document.querySelectorAll('.package-card');
            
            packageCards.forEach(card => {
                const appId = card.querySelector('input[type="checkbox"]').dataset.appId;
                const status = statusData[appId];
                
                if (status) {
                    const statusBadge = card.querySelector('.status-badge');
                    const versionSpan = card.querySelector('.version');
                    const toggle = card.querySelector('input[type="checkbox"]');
                    
                    if (status.installed) {
                        statusBadge.textContent = 'Installed';
                        statusBadge.className = 'status-badge installed';
                        versionSpan.textContent = status.version || '';
                        toggle.checked = true;
                    } else {
                        statusBadge.textContent = 'Not Installed';
                        statusBadge.className = 'status-badge not-installed';
                        versionSpan.textContent = '';
                        toggle.checked = false;
                    }
                }
            });
            addLogEntry('Package status updated from cache', 'SUCCESS');
        }

        /**
         * Performs initial bulk status check for all packages
         * Called only once during initial load
         */
        async function performInitialBulkCheck() {
            const packageCards = document.querySelectorAll('.package-card');
            const statusCache = {};
            
            try {
                const packageIds = Array.from(packageCards).map(card => 
                    card.querySelector('input[type="checkbox"]').dataset.appId
                );
                
                addLogEntry(`Checking status for ${packageIds.length} packages...`, 'INFO');
                
                for (const appId of packageIds) {
                    const card = Array.from(packageCards).find(card => 
                        card.querySelector('input[type="checkbox"]').dataset.appId === appId
                    );
                    
                    addLogEntry(`Checking status for ${appId}...`, 'DEBUG');
                    
                    const response = await fetch('http://localhost:9000/api/winget/bulk-package-status', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ appId, refresh: true })
                    });
                    
                    const data = await response.json();
                    statusCache[appId] = data;
                    
                    // Update UI for this package
                    const statusBadge = card.querySelector('.status-badge');
                    const versionSpan = card.querySelector('.version');
                    const toggle = card.querySelector('input[type="checkbox"]');
                    
                    if (data.installed) {
                        statusBadge.textContent = 'Installed';
                        statusBadge.className = 'status-badge installed';
                        versionSpan.textContent = data.version || '';
                        toggle.checked = true;
                        addLogEntry(`${appId} is installed (version ${data.version || 'unknown'})`, 'SUCCESS');
                    } else {
                        statusBadge.textContent = 'Not Installed';
                        statusBadge.className = 'status-badge not-installed';
                        versionSpan.textContent = '';
                        toggle.checked = false;
                        addLogEntry(`${appId} is not installed`, 'INFO');
                    }
                }
                
                // Cache the status data
                sessionStorage.setItem('packageStatus', JSON.stringify(statusCache));
                addLogEntry('Initial bulk status check completed', 'SUCCESS');
                
            } catch (error) {
                addLogEntry(`Error during bulk status check: ${error.message}`, 'ERROR');
                
                // Show error in UI
                packageCards.forEach(card => {
                    const statusBadge = card.querySelector('.status-badge');
                    statusBadge.textContent = 'Error';
                    statusBadge.className = 'status-badge not-installed';
                });
            }
        }

        /**
         * Handles package installation/uninstallation
         * @param {string} appId - The package identifier
         * @param {HTMLElement} toggle - The toggle button element
         */
        async function handlePackageToggle(appId, toggle) {
            const card = toggle.closest('.package-card');
            const statusBadge = card.querySelector('.status-badge');
            const versionSpan = card.querySelector('.version');
            const action = toggle.checked ? 'install' : 'uninstall';
            
            addLogEntry(`Starting ${action} for ${appId}...`, 'INFO');
            statusBadge.textContent = toggle.checked ? 'Installing...' : 'Uninstalling...';
            toggle.disabled = true;
            
            try {
                const response = await fetch(`http://localhost:9000/api/winget/${action}-package`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appId })
                });

                // Poll for status changes
                let attempts = 0;
                const maxAttempts = 30;
                const pollInterval = 5000;
                let isComplete = false;

                while (!isComplete && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, pollInterval));
                    addLogEntry(`Checking ${action} status for ${appId} (attempt ${attempts + 1})...`, 'DEBUG');
                    
                    const statusResponse = await fetch('http://localhost:9000/api/winget/single-package-status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ appId, refresh: true })
                    });
                    
                    const data = await statusResponse.json();
                    
                    if (data.installed === toggle.checked) {
                        isComplete = true;
                        
                        if (data.installed) {
                            statusBadge.textContent = 'Installed';
                            statusBadge.className = 'status-badge installed';
                            versionSpan.textContent = data.version || '';
                            toggle.checked = true;
                            addLogEntry(`Successfully installed ${appId} (version ${data.version || 'unknown'})`, 'SUCCESS');
                        } else {
                            statusBadge.textContent = 'Not Installed';
                            statusBadge.className = 'status-badge not-installed';
                            versionSpan.textContent = '';
                            toggle.checked = false;
                            addLogEntry(`Successfully uninstalled ${appId}`, 'SUCCESS');
                        }
                    } else {
                        statusBadge.textContent = toggle.checked ? 'Installing...' : 'Uninstalling...';
                    }
                    
                    attempts++;
                }
                
                if (!isComplete) {
                    throw new Error(`${action} operation timed out after ${maxAttempts * pollInterval / 1000} seconds`);
                }
                
            } catch (error) {
                statusBadge.textContent = 'Error';
                toggle.checked = !toggle.checked;
                addLogEntry(`Error during ${action}: ${error.message}`, 'ERROR');
            } finally {
                toggle.disabled = false;
            }
        }

        /**
         * Refreshes the status of a single package
         * @param {string} appId - The package identifier
         * @param {HTMLElement} button - The refresh button element
         */
        async function refreshPackage(appId, button) {
            const card = button.closest('.package-card');
            const statusBadge = card.querySelector('.status-badge');
            const refreshIcon = button.querySelector('.refresh-icon');
            
            addLogEntry(`Refreshing status for ${appId}...`, 'INFO');
            button.disabled = true;
            statusBadge.textContent = 'Checking...';
            refreshIcon.style.transform = 'rotate(360deg)';
            
            try {
                const response = await fetch('http://localhost:9000/api/winget/single-package-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ appId, refresh: true })
                });
                
                const data = await response.json();
                const versionSpan = card.querySelector('.version');
                const toggle = card.querySelector('input[type="checkbox"]');
                
                if (data.installed) {
                    statusBadge.textContent = 'Installed';
                    statusBadge.className = 'status-badge installed';
                    versionSpan.textContent = data.version || '';
                    toggle.checked = true;
                    addLogEntry(`${appId} is installed (version ${data.version || 'unknown'})`, 'SUCCESS');
                } else {
                    statusBadge.textContent = 'Not Installed';
                    statusBadge.className = 'status-badge not-installed';
                    versionSpan.textContent = '';
                    toggle.checked = false;
                    addLogEntry(`${appId} is not installed`, 'INFO');
                }
            } catch (error) {
                statusBadge.textContent = 'Error';
                statusBadge.className = 'status-badge not-installed';
                addLogEntry(`Error refreshing status for ${appId}: ${error.message}`, 'ERROR');
            } finally {
                button.disabled = false;
                refreshIcon.style.transform = 'rotate(0deg)';
            }
        }

        /**
         * Forces a bulk status check for all packages
         * Updates the cache and UI with fresh data
         */
        async function forceBulkStatusCheck() {
            const bulkRefreshBtn = document.querySelector('.bulk-refresh-btn');
            const packageCards = document.querySelectorAll('.package-card');
            
            addLogEntry('Starting forced bulk status check...', 'INFO');
            bulkRefreshBtn.disabled = true;
            
            try {
                packageCards.forEach(card => {
                    const statusBadge = card.querySelector('.status-badge');
                    statusBadge.textContent = 'Checking...';
                });
                
                await performInitialBulkCheck();
                addLogEntry('Forced bulk status check completed successfully', 'SUCCESS');
            } catch (error) {
                addLogEntry(`Error during forced bulk status check: ${error.message}`, 'ERROR');
                
                packageCards.forEach(card => {
                    const statusBadge = card.querySelector('.status-badge');
                    statusBadge.textContent = 'Error';
                    statusBadge.className = 'status-badge not-installed';
                });
            } finally {
                bulkRefreshBtn.disabled = false;
            }
        }
    </script>
</body>
</html> 
